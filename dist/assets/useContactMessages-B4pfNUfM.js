import{j as y}from"./ui-B2Y7o2X1.js";import{r as b}from"./vendor-BsBmf7g_.js";import{g as S,b as v,u as _,o as M,s as u}from"./index-BYGJTMIk.js";import{u as D}from"./useQuery-CdAOd0lP.js";import{u as l}from"./useMutation-DkpW_JRO.js";const x=b.forwardRef(({className:o,...n},g)=>y.jsx("textarea",{className:S("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",o),ref:g,...n}));x.displayName="Textarea";function $(){const{user:o}=v(),{toast:n}=_(),g=M(),i=["f4c09bd2-db18-44f3-8eb9-66a50e883b67","09961117-d889-4ed7-bfcf-cac6b5e4e5a6"].includes((o==null?void 0:o.id)||"");console.log("Configuração do Supabase:",{url:u.supabaseUrl,hasAnonKey:!!u.supabaseKey,user:o==null?void 0:o.id,isAdmin:i});const{data:a,isLoading:h,error:w,refetch:E}=D({queryKey:["contact-messages"],queryFn:async()=>{if(!i)throw new Error("Acesso negado: apenas administradores podem visualizar mensagens");const{data:e,error:t}=await u.from("contact_messages").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]},enabled:i,staleTime:30*1e3}),m=l({mutationFn:async e=>{try{const t=navigator.userAgent;let r=null;try{const c=await fetch("https://api.ipify.org?format=json");c.ok&&(r=(await c.json()).ip)}catch(c){console.warn("Erro ao obter IP:",c)}console.log("Tentando inserir mensagem:",{...e,source:"contact_form",ip_address:r,user_agent:t,status:"pending",priority:"normal"});const{data:s,error:d}=await u.from("contact_messages").insert({...e,source:"contact_form",ip_address:r,user_agent:t,status:"pending",priority:"normal"}).select().single();if(d)throw console.error("Erro do Supabase:",d),new Error(`Erro do banco de dados: ${d.message} (${d.code})`);if(!s)throw new Error("Nenhum dado retornado após inserção");return console.log("Mensagem inserida com sucesso:",s),s}catch(t){throw console.error("Erro completo na criação da mensagem:",t),t instanceof Error?t:new Error(`Erro inesperado: ${String(t)}`)}},onSuccess:()=>{i&&g.invalidateQueries({queryKey:["contact-messages"]}),n({title:"Mensagem enviada com sucesso!",description:"Nossa equipe entrará em contato em até 24 horas."})},onError:e=>{console.error("Erro no onError do mutation:",e),n({title:"Erro ao enviar mensagem",description:e instanceof Error?e.message:`Erro desconhecido: ${String(e)}`,variant:"destructive"})}}),f=l({mutationFn:async({messageId:e,status:t,adminNotes:r})=>{if(!i)throw new Error("Acesso negado: apenas administradores podem atualizar mensagens");const s={status:t,updated_at:new Date().toISOString()};t==="read"&&!s.read_at&&(s.read_at=new Date().toISOString()),t==="replied"&&!s.replied_at&&(s.replied_at=new Date().toISOString()),r&&(s.admin_notes=r);const{data:d,error:c}=await u.from("contact_messages").update(s).eq("id",e).select().single();if(c)throw c;return d},onSuccess:e=>{g.setQueryData(["contact-messages"],t=>t?t.map(r=>r.id===e.id?e:r):[e]),n({title:"Status atualizado",description:`Mensagem marcada como ${e.status}.`})},onError:e=>{n({title:"Erro ao atualizar status",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"})}}),p=l({mutationFn:async e=>{if(!i)throw new Error("Acesso negado: apenas administradores podem deletar mensagens");const{error:t}=await u.from("contact_messages").delete().eq("id",e);if(t)throw t},onSuccess:(e,t)=>{g.setQueryData(["contact-messages"],r=>r?r.filter(s=>s.id!==t):[]),n({title:"Mensagem removida",description:"A mensagem foi removida com sucesso."})},onError:e=>{n({title:"Erro ao remover mensagem",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"})}});return{messages:a,isLoadingMessages:h,messagesError:w,messageStats:a?{total:a.length,pending:a.filter(e=>e.status==="pending").length,read:a.filter(e=>e.status==="read").length,replied:a.filter(e=>e.status==="replied").length,archived:a.filter(e=>e.status==="archived").length,urgent:a.filter(e=>e.priority==="urgent").length,high:a.filter(e=>e.priority==="high").length,today:a.filter(e=>{const t=new Date().toDateString();return new Date(e.created_at).toDateString()===t}).length,thisWeek:a.filter(e=>{const t=new Date;return t.setDate(t.getDate()-7),new Date(e.created_at)>=t}).length}:null,createMessage:m.mutate,updateMessageStatus:f.mutate,deleteMessage:p.mutate,refetchMessages:E,isCreatingMessage:m.isPending,isUpdatingStatus:f.isPending,isDeletingMessage:p.isPending,isAdmin:i}}export{x as T,$ as u};
